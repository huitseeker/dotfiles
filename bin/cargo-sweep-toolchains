#!/bin/sh -eux

if ! cargo sweep >/dev/null 2>&1 ; then
  cargo install cargo-sweep
fi

export PATH="$PATH:$HOME/.cargo/bin"
cd "$HOME"

for project in $(find . -name "Cargo.toml" -type f | grep -vE "(registry|.rustup|.cargo|target)" | xargs dirname); do
  if [ -d "$project" ]; then
    cd "$project"
    current_toolchain=$(rustup toolchain list | grep "override" | awk '{print $1}')
    if [ "$current_toolchain" ]; then
      cargo sweep --toolchains="$current_toolchain"
    else
      rustup toolchain list | grep "default" | awk '{print $1}' | xargs -I{} cargo sweep --toolchains="{}"
    fi
  fi
done
